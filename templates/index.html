<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phân loại trạng thái trái chuối 🍌</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
</head>
<body>
  <header>
    <img src="{{ url_for('static', filename='LogoBanana.png') }}" alt="Logo" class="logo" />
    <h1>Phân loại trạng thái của trái chuối 🍌</h1>
  </header>

  <div class="container">
    <!-- Cột trái -->
    <div class="left-column">
      <div class="section">
        <h2>📥 Tải ảnh từ máy</h2>
        <form method="POST" enctype="multipart/form-data">
          <input type="file" id="imageInput" name="image" accept="image/*" style="display:none;" required>
          <label for="imageInput" class="preview-box">
            <div id="previewContent" class="preview-content">
              <img src="{{ url_for('static', filename='icons/image-icon.png') }}" class="preview-icon" />
              <span class="preview-text">Chọn ảnh</span>
            </div>
            <img id="previewImage" />
          </label>
          <button type="submit">📤 Phân loại</button>
        </form>
      </div>

      <div class="section">
        <h2>📸 Chụp ảnh từ camera</h2>
        <video id="video" autoplay playsinline></video>
        <button onclick="capture()">📷 Chụp & Phân loại</button>
        <form id="camForm" method="POST" style="display:none;">
          <input type="hidden" name="cam_image" id="cam_image">
        </form>
      </div>

      <div style="text-align:center;">
        <button onclick="showReport()">📊 Xuất báo cáo</button>
      </div>
    </div>

    <!-- Cột phải -->
    <div class="right-column">
      <div id="reportSection" class="section">
  <h2>📊 Thống kê phân loại</h2>
  <table id="reportTable">
    <thead>
      <tr>
        <th>Loại</th>
        <th>Số lượng</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Tổng</td>
        <td>0</td>
      </tr>
    </tbody>
  </table>
  <div style="display: flex; justify-content: space-between; margin-top: 12px;">
    <button class="btn-csv" onclick="downloadCSV()">📥 CSV</button>
    <button class="btn-reset" onclick="resetReport()">🗑 Reset</button>
  </div>
</div>

    </div>
  </div>

  <footer>
    CheckBanana.AI &copy; 2025 - AgriTech Assistant
  </footer>

  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Đang phân tích, vui lòng chờ...</p>
  </div>

  <script>
    // Webcam
    const video = document.getElementById('video');
    const camImage = document.getElementById('cam_image');
    const camForm = document.getElementById('camForm');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(() => alert("Không thể truy cập camera."));

    function capture() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      camImage.value = canvas.toDataURL('image/jpeg');
      camForm.submit();
    }

    // Preview ảnh
    const fileInput = document.getElementById('imageInput');
    const previewImage = document.getElementById('previewImage');
    const previewContent = document.getElementById('previewContent');

    fileInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImage.src = e.target.result;
          previewImage.style.display = 'block';
          previewContent.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    // Loading overlay
    const form = document.querySelector('form[method="POST"]');
    const loadingOverlay = document.getElementById('loadingOverlay');
    form.addEventListener('submit', () => loadingOverlay.style.display = 'block');

    // Báo cáo
    function recordResult(label) {
      const stats = JSON.parse(localStorage.getItem('bananaStats') || '{}');
      stats[label] = (stats[label] || 0) + 1;
      localStorage.setItem('bananaStats', JSON.stringify(stats));
    }

    function showReport() {
      const stats = JSON.parse(localStorage.getItem('bananaStats') || '{}');
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';
      let total = 0;
      for (let label in stats) {
        const count = stats[label];
        total += count;
        tbody.innerHTML += `<tr><td>${label}</td><td>${count}</td></tr>`;
      }
      tbody.innerHTML += `<tr style="font-weight:bold;"><td>Tổng</td><td>${total}</td></tr>`;
    }

    function resetReport() {
      if (confirm("Bạn có chắc chắn muốn xóa dữ liệu?")) {
        localStorage.removeItem('bananaStats');
        document.querySelector('#reportTable tbody').innerHTML = '<tr><td>Tổng</td><td>0</td></tr>';
      }
    }

    function downloadCSV() {
  const stats = JSON.parse(localStorage.getItem('bananaStats') || '{}');
  if (Object.keys(stats).length === 0) {
    alert("Không có dữ liệu để xuất CSV.");
    return;
  }

  let csvContent = "Loại,Số lượng\n";
  let total = 0;
  for (let label in stats) {
    csvContent += `${label},${stats[label]}\n`;
    total += stats[label];
  }
  csvContent += `Tổng,${total}\n`;

  // 🔥 Thêm BOM để hỗ trợ tiếng Việt
  const BOM = "\uFEFF"; // Byte Order Mark
  const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });

  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "bao_cao_phan_loai.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

  </script>
</body>
</html>
